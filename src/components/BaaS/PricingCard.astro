---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";

type Props = {
  baasProvider: CollectionEntry<"baasProvider">;
};

const { baasProvider } = Astro.props;
const pricing = baasProvider.data.pricing;

const formatValue = (value: any, isPrice: boolean = false) => {
  if (value === null) return "-";
  if (value === "unlimited") return "Unlimited";
  if (isPrice)
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 6,
    }).format(value);
  if (typeof value === "number")
    return new Intl.NumberFormat("en-US").format(value);
  return value;
};

const getOveragePricingUnit = (key: string) => {
  switch (key) {
    case "Team members":
      return "per member";
    case "Projects":
      return "per project";
    case "Auth users":
      return "per user";
    case "DB storage":
    case "DB bandwidth":
    case "File storage":
    case "File bandwidth":
      return "per GB";
    case "Function calls":
      return "per 1,000,000";
    default:
      return "";
  }
};
---

<div class="space-y-4">
  {
    Object.keys(pricing?.freeTierLimits ?? {}).map((key, index) => (
      <div class="overflow-hidden rounded-lg bg-white shadow">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900">{key}</h3>
          <div class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-3">
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">
                Free resources
              </dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">
                {key === "Price" ? (
                  pricing?.freeTierLimits[
                    key as keyof typeof pricing.freeTierLimits
                  ] === null ? (
                    <Icon name="mdi:check" class="h-8 w-8 text-green-500" />
                  ) : (
                    formatValue(
                      pricing?.freeTierLimits[
                        key as keyof typeof pricing.freeTierLimits
                      ],
                      true,
                    )
                  )
                ) : (
                  formatValue(
                    pricing?.freeTierLimits[
                      key as keyof typeof pricing.freeTierLimits
                    ],
                  )
                )}
              </dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">
                Pricing plan
              </dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">
                {key === "Price"
                  ? pricing?.pricedTier[
                      key as keyof typeof pricing.pricedTier
                    ] === null
                    ? `${baasProvider.data.name} offers usage-based pricing only`
                    : `${formatValue(
                        pricing?.pricedTier[
                          key as keyof typeof pricing.pricedTier
                        ],
                        true,
                      )}/month`
                  : formatValue(
                      pricing?.pricedTier[
                        key as keyof typeof pricing.pricedTier
                      ],
                    )}
              </dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">
                Over-limit Fees
              </dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">
                {(() => {
                  const value =
                    pricing?.overagePricing[
                      key as keyof typeof pricing.overagePricing
                    ];
                  if (value === null) {
                    return "-";
                  } else if (key === "Price") {
                    return (
                      <Icon name="mdi:check" class="h-8 w-8 text-green-500" />
                    );
                  } else if (key !== "Note") {
                    return `${formatValue(value, true)} ${getOveragePricingUnit(key)}`;
                  }
                  return formatValue(value, key !== "Note");
                })()}
              </dd>
            </div>
          </div>
        </div>
      </div>
    ))
  }
</div>
